#include "common.h"
#include "win32.h"

typedef struct {
    int half_transitions;
    b32 down;
} key_state;

typedef struct {
    key_state forward;
    key_state backward;
    key_state left;
    key_state right;
} input_state;

typedef struct game_state {
    b32 is_running;
    u64 frame;
    u32 shader_id;
    u32 vao;
    u32 vbo;
    u32 text_shader_id;
    u32 text_vao;
    u32 text_vbo;
    u32 glerr;
    u32 arial_texture;
} game_state;

game_state *gs = 0;
arena permanent_arena;
arena transient_arena;
allocator permanent_allocator;
allocator transient_allocator;

void game_init(game_memory *memory) {
    permanent_arena = (arena){
        .base = memory->permanent_storage,
        .size = memory->permanent_storage_size,
    };
    transient_arena = (arena){
        .base = memory->transient_storage,
        .size = memory->transient_storage_size,
    };
    permanent_allocator = arena_alloc_init(&permanent_arena);
    transient_allocator = arena_alloc_init(&transient_arena);
    gs = make(game_state, 1, permanent_allocator);

    // NOTE: Move these somewhere appropriate.
    gs->shader_id = draw_shader_create("runtime/vert.glsl", "runtime/frag.glsl", transient_allocator);
    assert(gs->shader_id && "Failed to create shader.");

    f32 vertices[] = {
        -0.5f, -0.5f, 0.f,
         0.5f, -0.5f, 0.f,
         0.0f,  0.5f, 0.f,
    };

    f32 colors[] = {
        1.f, 0.f, 0.f,
        0.f, 1.f, 0.f,
        0.f, 0.f, 1.f,
    };
    (void)colors;

    glGenVertexArrays(1, &gs->vao);
    glGenBuffers(1, &gs->vbo);
    glBindVertexArray(gs->vao);
    glBindBuffer(GL_ARRAY_BUFFER, gs->vbo);
    glBufferData(GL_ARRAY_BUFFER, 9 * sizeof(f32), vertices, GL_STATIC_DRAW);
    glVertexAttribPointer(0, 3, GL_FLOAT, 0, 3 * sizeof(f32), (void *)0);
    glEnableVertexAttribArray(0);

    glBindVertexArray(0);

    gs->text_shader_id = draw_shader_create("runtime/text_vert.glsl", "runtime/text_frag.glsl", transient_allocator);
    assert(gs->text_shader_id);

    glEnable(GL_BLEND);
    glBlendFunc(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);
    glViewport(0, 0, WINDOW_WIDTH, WINDOW_HEIGHT);

    m4 projection = {0};
    m4_ortho(&projection, 0.f, WINDOW_WIDTH, WINDOW_HEIGHT, 0.f, -1.f, 1.f);

    glUseProgram(gs->text_shader_id);
    {
        i32 uloc = glGetUniformLocation(gs->text_shader_id, "projection");
        glUniformMatrix4fv(uloc, 1, 0, &projection.data[0][0]);
    }

    #define bottom_left   0.0f,  0.0f, 0.f,   0.f, 0.f,   0.f, 0.f, 1.f, 1.f
    #define bottom_right  1.0f,  0.0f, 0.f,   1.f, 0.f,   1.f, 1.f, 0.f, 1.f
    #define top_right     1.0f,  1.0f, 0.f,   1.f, 1.f,   0.f, 1.f, 0.f, 1.f
    #define top_left      0.0f,  1.0f, 0.f,   0.f, 1.f,   1.f, 0.f, 0.f, 1.f
    f32 quad_vertices[] = {
        bottom_left, bottom_right, top_right,
        bottom_left, top_right, top_left,
    };

    glGenVertexArrays(1, &gs->text_vao);
    glGenBuffers(1, &gs->text_vbo);
    glBindVertexArray(gs->text_vao);
    glBindBuffer(GL_ARRAY_BUFFER, gs->text_vbo);
    glBufferData(GL_ARRAY_BUFFER, 60 * sizeof(f32), quad_vertices, GL_STATIC_DRAW);
    glVertexAttribPointer(0, 3, GL_FLOAT, 0, 9 * sizeof(f32), (void *)0);
    glEnableVertexAttribArray(0);
    glVertexAttribPointer(1, 2, GL_FLOAT, 0, 9 * sizeof(f32), (void *)(3 * sizeof(f32)));
    glEnableVertexAttribArray(1);
    glVertexAttribPointer(2, 4, GL_FLOAT, 0, 9 * sizeof(f32), (void *)(5 * sizeof(f32)));
    glEnableVertexAttribArray(2);

    byte msdf_image_data[] = {
        0x5C, 0x3C, 0x3C, 0xD3, 0x3C, 0x3C, 0xFF, 0x3C, 0x3C, 0xA3, 0x3C, 0x3C, 0x2B, 0x2B, 0x3C, 0x00, 0x00, 0x3C, 0x00, 0x00, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3C, 0x00, 0x00, 0x3C, 0x00, 0x00, 0x3C, 0x33, 0x33, 0x3C, 0xAB, 0x3C, 0x3C, 0xFF, 0x3C, 0x3C, 0xD4, 0x3C, 0x3C, 0x5D, 0x3C,
        0x2E, 0xBC, 0x2E, 0xA5, 0xBC, 0xA5, 0xFF, 0xBC, 0xBC, 0xCF, 0xBC, 0xBC, 0x57, 0x57, 0xBC, 0x00, 0x00, 0xBC, 0x00, 0x00, 0xBC, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xBC, 0x00, 0x00, 0xBC, 0x00, 0x00, 0xBC, 0x61, 0x61, 0xBC, 0xD9, 0xBC, 0xBC, 0xFF, 0xBC, 0xBC, 0xA4, 0xA4, 0xBC, 0x2D, 0x2D,
        0x00, 0xFF, 0x00, 0x77, 0xFF, 0x77, 0xEE, 0xFF, 0xEE, 0xFB, 0xFB, 0xFF, 0x82, 0x82, 0xFF, 0x0A, 0x0A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0xFF, 0x8F, 0x8F, 0xFF, 0xFF, 0xFF, 0xFF, 0xEC, 0xEC, 0xFF, 0x75, 0x75, 0xFF, 0x00, 0x00,
        0x00, 0xFF, 0x00, 0x48, 0xFF, 0x48, 0xBF, 0xFF, 0xBF, 0xFF, 0xFF, 0xFF, 0xAE, 0xAE, 0x27, 0x36, 0x36, 0x27, 0x27, 0x00, 0x27, 0x27, 0x00, 0x27, 0x27, 0x00, 0x27, 0x27, 0x00, 0x27, 0x27, 0x46, 0x46, 0x27, 0xBD, 0xBD, 0x27, 0xFF, 0xFF, 0xFF, 0xBC, 0xBC, 0xFF, 0x45, 0x45, 0xFF, 0x00, 0x00,
        0x00, 0xFF, 0x00, 0x1A, 0xFF, 0x1A, 0x91, 0xFF, 0x91, 0xFF, 0xFF, 0xFF, 0xDA, 0xDA, 0xA7, 0xA7, 0x62, 0xA7, 0xA7, 0x00, 0xA7, 0xA7, 0x00, 0xA7, 0xA7, 0x00, 0xA7, 0xA7, 0x00, 0xA7, 0xA7, 0x74, 0xA7, 0xA7, 0xEB, 0xEB, 0xA7, 0xFF, 0xFF, 0xA7, 0x8C, 0x8C, 0xFF, 0x16, 0x16, 0xFF, 0x00, 0x00,
        0x00, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x62, 0xFF, 0x62, 0xDA, 0xFF, 0xDA, 0xFF, 0xFF, 0xFF, 0xFF, 0x8F, 0xFF, 0xFF, 0x16, 0xFF, 0xFF, 0x00, 0xFF, 0xFF, 0x00, 0xFF, 0xFF, 0x2B, 0xFF, 0xFF, 0xA3, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xD4, 0xD4, 0xFF, 0x5D, 0x5D, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x00,
        0x00, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x34, 0xFF, 0x34, 0xAB, 0xFF, 0xAB, 0xFF, 0xFF, 0xFF, 0x85, 0xBA, 0xBA, 0x85, 0x42, 0x85, 0x85, 0x00, 0x85, 0x85, 0x00, 0x85, 0x85, 0x58, 0x85, 0xD0, 0xD0, 0x85, 0xFF, 0xFF, 0xFF, 0xFF, 0xA4, 0xA4, 0xFF, 0x2D, 0x2D, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x00,
        0x00, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x06, 0xFF, 0x06, 0x7D, 0xFF, 0x7D, 0xF4, 0xFF, 0xF4, 0x05, 0xE6, 0xE6, 0x05, 0x6E, 0x6E, 0x05, 0x00, 0x05, 0x0D, 0x0D, 0x05, 0x85, 0x85, 0x05, 0xFD, 0xFD, 0x05, 0xFF, 0xEB, 0xEB, 0xFF, 0x74, 0x74, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x00,
        0x00, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x4E, 0xFF, 0x4E, 0xC6, 0xFF, 0xC6, 0xFF, 0xFF, 0xFF, 0x00, 0x9A, 0x9A, 0x00, 0x21, 0x21, 0x39, 0x39, 0x00, 0xB1, 0xB1, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xBC, 0xBC, 0xFF, 0x45, 0x45, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x00,
        0x00, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x20, 0xFF, 0x20, 0x97, 0xFF, 0x97, 0xFF, 0xFF, 0xFF, 0xFF, 0xC6, 0xC6, 0x00, 0x4D, 0x4D, 0x66, 0x66, 0x00, 0xDE, 0xDE, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x8C, 0x8C, 0xFF, 0x15, 0x15, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x00,
        0x00, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x69, 0xFF, 0x69, 0xE0, 0xFF, 0xE0, 0xFF, 0xF1, 0xF1, 0x1A, 0x79, 0x79, 0x92, 0x92, 0x01, 0xFF, 0xFF, 0xFF, 0xFF, 0xD3, 0xD3, 0xFF, 0x5D, 0x5D, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x00,
        0x00, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x3A, 0xFF, 0x3A, 0xB2, 0xFF, 0xB2, 0xFF, 0xFF, 0xFF, 0x47, 0xA5, 0xA5, 0xBF, 0xBF, 0x2D, 0xFF, 0xFF, 0xFF, 0xFF, 0xA4, 0xA4, 0xFF, 0x2D, 0x2D, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x00,
        0x00, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x0C, 0xFF, 0x0C, 0x83, 0xFF, 0x83, 0xFA, 0xFF, 0xFA, 0x73, 0xD1, 0xD1, 0xEB, 0xEB, 0x58, 0xFF, 0xEB, 0xEB, 0xFF, 0x74, 0x74, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x00,
        0x00, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x55, 0xFF, 0x55, 0xCC, 0xFF, 0xCC, 0xFF, 0xFC, 0xFC, 0xFF, 0xFF, 0xFF, 0xFF, 0xBB, 0xBB, 0xFF, 0x45, 0x45, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x00,
        0x00, 0xBC, 0x00, 0x00, 0xBC, 0x00, 0x00, 0xBC, 0x00, 0x00, 0xBC, 0x00, 0x00, 0xBC, 0x00, 0x26, 0xBC, 0x26, 0x9D, 0xBC, 0x9D, 0xBC, 0xBC, 0xFF, 0xBC, 0xBC, 0xFF, 0xBC, 0x8C, 0x8C, 0xBC, 0x15, 0x15, 0xBC, 0x00, 0x00, 0xBC, 0x00, 0x00, 0xBC, 0x00, 0x00, 0xBC, 0x00, 0x00, 0xBC, 0x00, 0x00,
        0x00, 0x3C, 0x00, 0x00, 0x3C, 0x00, 0x00, 0x3C, 0x00, 0x00, 0x3C, 0x00, 0x00, 0x3C, 0x00, 0x00, 0x3C, 0x00, 0x3C, 0x3C, 0x6F, 0x3C, 0x3C, 0xE6, 0x3C, 0x3C, 0xD3, 0x3C, 0x3C, 0x5C, 0x3C, 0x00, 0x00, 0x3C, 0x00, 0x00, 0x3C, 0x00, 0x00, 0x3C, 0x00, 0x00, 0x3C, 0x00, 0x00, 0x3C, 0x00, 0x00
    };

    glGenTextures(1, &gs->arial_texture);
    glBindTexture(GL_TEXTURE_2D, gs->arial_texture);
    // glTexStorage2D(GL_TEXTURE_2D, 0, GL_RGBA8, 16, 16, 1);
    glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR);
    glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_LINEAR);
    glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_S, GL_CLAMP_TO_BORDER);
    glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_T, GL_CLAMP_TO_BORDER);
    glTexImage2D(GL_TEXTURE_2D, 0, GL_RGBA8, 16, 16, 0, GL_RGB, GL_UNSIGNED_BYTE, msdf_image_data);
    glBindTexture(GL_TEXTURE_2D, 0);
}

void game_update_and_render(input_state *input) {
    if (input->forward.down) {
        MessageBox(0, "ARST", "ARST", 0);
        input->forward.down = 0;
    }

    // glUseProgram(gs->shader_id);
    // glBindVertexArray(gs->vao);
    // glDrawArrays(GL_TRIANGLES, 0, 3);
    glActiveTexture(GL_TEXTURE0 + 0);
    glBindTexture(GL_TEXTURE_2D, gs->arial_texture);
    i32 uloc = glGetUniformLocation(gs->text_shader_id, "msdf");
    glUniform1i(uloc, 0);
    glUseProgram(gs->text_shader_id);
    glBindVertexArray(gs->text_vao);
    glDrawArrays(GL_TRIANGLES, 0, 6);

    gs->frame += 1;
}
